version: "3.8"

services:
  backend:
    build: ./backend
    container_name: homelab-portal-backend
    restart: unless-stopped
    network_mode: host
    pid: "host" # Share host's process namespace to see all Pi processes
    volumes:
      # Mount Docker socket for container monitoring
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Mount thermal zone for temperature monitoring
      - /sys/class/thermal:/sys/class/thermal:ro
      # Mount network statistics for accurate monitoring
      - /sys/class/net:/sys/class/net:ro
      # Mount /proc for process monitoring (read memory/CPU from host)
      - /proc:/host/proc:ro
      # Mount /etc/passwd to resolve usernames
      - /etc/passwd:/etc/passwd:ro
      # Mount host root filesystem (read-only) for universal disk monitoring
      - /:/host:ro
      # Persist database using named volume (survives container rebuilds)
      - backend-data:/app/data
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3001/health').then(r => { if (!r.ok) process.exit(1) }).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    environment:
      - NODE_ENV=production
      - PORT=3001
      - DB_PATH=/app/data/homelab.db
      - HOST_PROC=/host/proc
    # Allow access to host system metrics
    privileged: false
    # Read-only root filesystem for security (except data volume)
    # read_only: true  # Uncomment if you want extra security

  frontend:
    build: ./frontend
    container_name: homelab-portal-frontend
    restart: unless-stopped
    ports:
      - "1781:80"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - homelab-network

networks:
  homelab-network:
    driver: bridge

volumes:
  backend-data:
