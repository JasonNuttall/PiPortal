version: "3.8"

services:
  backend:
    build: ./backend
    container_name: homelab-portal-backend
    restart: unless-stopped
    network_mode: host
    pid: "host" # Share host's process namespace to see all Pi processes
    volumes:
      # Mount Docker socket for container monitoring
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Mount thermal zone for temperature monitoring
      - /sys/class/thermal:/sys/class/thermal:ro
      # Mount network statistics for accurate monitoring
      - /sys/class/net:/sys/class/net:ro
      # Mount /proc for process monitoring (read memory/CPU from host)
      - /proc:/host/proc:ro
      # Mount /etc/passwd to resolve usernames
      - /etc/passwd:/etc/passwd:ro
      # Persist database using named volume (survives container rebuilds)
      - backend-data:/app/data
    environment:
      - NODE_ENV=production
      - PORT=3001
      - DB_PATH=/app/data/homelab.db
      - HOST_PROC=/host/proc
    # Allow access to host system metrics
    privileged: false
    # Read-only root filesystem for security (except data volume)
    # read_only: true  # Uncomment if you want extra security

  frontend:
    build: ./frontend
    container_name: homelab-portal-frontend
    restart: unless-stopped
    ports:
      - "1781:80"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - backend
    networks:
      - homelab-network

networks:
  homelab-network:
    driver: bridge

volumes:
  backend-data:
